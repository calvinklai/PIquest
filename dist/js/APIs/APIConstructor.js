define(["require","underscore"],function(e){function r(r){function s(){var e=this.script={name:"anonymous "+r.type,settings:{},current:{},sequence:[]};this.settings=e.settings,t.forEach(r.sets,function(t){e[t+"Sets"]=[]})}return t.forEach(r.sets,function(e){s.prototype[t.camelCase("add-"+e+"-set")]=i(e)}),t.extend(s.prototype,{setName:function(e){this.script.name=e},addSettings:function(e,n){var r;return t.isPlainObject(n)?(r=this.settings[e]=this.settings[e]||{},t.extend(r,n)):this.settings[e]=n,this},addSequence:function(e){var n=this.script;return t.isArray(e)||(e=[e]),n.sequence=n.sequence.concat(e),this},addGlobal:function(e){if(!t.isPlainObject(e))throw new Error("global must be an object");return t.merge(n,e)},getGlobal:function(){return n},addCurrent:function(e){if(!t.isPlainObject(e))throw new Error("current must be an object");return t.merge(this.script.current,e)},getCurrent:function(){return this.script.current},addScript:function(e){return t.merge(this.script,e)},getScript:function(){return this.script},post:function(t,n){if(e.defined("jquery"))return e("jquery").ajax({type:"POST",url:t,data:JSON.stringify(n),contentType:"application/json; charset=utf-8",dataType:"json"});var r=angular.injector(["ng"]);return r.invoke(["$http",function(e){return e.post(t,n)}])},shuffle:function(e){return t.shuffle(e)}}),s}function i(e){function n(n,r){var i=this.script[e+"Sets"]||(this.script[e+"Sets"]=[]),s;t.isPlainObject(n)&&(s=t(n).map(function(e,n){return t.each(e,function(e){e.set=n}),e}).flatten().value()),t.isArray(n)&&(s=n),t.isString(n)&&(s=t.isArray(r)?r:[r],s=t.map(s,function(e){return e.set=n,e})),i.push.apply(i,s)}return n}window.piGlobal||(window.piGlobal={});var t=e("underscore"),n=window.piGlobal;return r});
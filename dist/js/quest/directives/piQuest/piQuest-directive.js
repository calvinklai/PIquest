define(["require","underscore","text!./piQuest.html","angular"],function(e){function i(e,n,r,i,s){function h(t,n){u.next(n),e.$emit("quest:newPage")}function p(t,n){u.prev(n),e.$emit("quest:newPage")}var o=this,u=o.task=new r(e.script),a,f=n.global,l=e.script,c=n.global[l.name||"current"]=n.current={questions:{}};l.current&&t.extend(c,l.current),l.global&&t.extend(f,l.global),a={global:f,current:c,questions:c.questions},t.extend(i,a),t.extend(s,a),u.next(),e.$on("quest:next",h),e.$on("quest:prev",p),e.$on("quest:log",function(t,n,r){u.log(n,r,e.global)})}function s(e,s,o,u){return{replace:!0,controller:i,link:function(i,a,f,l){function v(){d&&(d.remove(),d=null),h&&(h.$destroy(),h=null),p&&(s.leave(p,function(){d=null}),d=p,p=null)}function m(){var t=c.current();if(t){var o=i.$new(),u=r(n);o.page=t,y(u,t.animate),v(),p=e(u)(o),s.enter(p,a),h=o,h.$emit("quest:updated")}else v()}function g(){h.page=c.current()}function y(e,n){if(!n)return;var r=n.split(" ");t.each(r,function(e){o.has("."+e+"-animation")||u(["page","animation"]).error('Unknown animation type: "'+e+'"')}),e.addClass(n)}var c=l.task,h,p,d;i.$on("quest:refresh",g),i.$on("quest:newPage",m),m()}}}var t=e("underscore"),n=e("text!./piQuest.html"),r=e("angular").element;return i.$inject=["$scope","$rootScope","Task","templateDefaultContext","mixerDefaultContext"],s.$inject=["$compile","$animate","$injector","piConsole"],s});
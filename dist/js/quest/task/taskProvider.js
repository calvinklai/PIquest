define(["underscore","angular"],function(e,t){function n(n,r,i,s,o,u,a){function f(f){var l=this,c=f.settings||{};this.script=f,this.db=new r,this.logger=new i(u),this.logger.setSettings(c.logger||{}),this.q=n.defer();if(!e.isArray(f.sequence))throw new Error("Task: no sequence was defined");this.sequence=new s(f.sequence,this.db),this.q.promise.then(function(){return l.logger.suppressPulse(),e.each(a.current.questions,function(e){if(e.$logged)return!0;l.log(e,{},a.global),e.$logged=!0}),l.logger.suppressPulse(!1),l.logger.send()}),this.q.promise.then(c.onEnd||t.noop),o(f,this.db)}return e.extend(f.prototype,{log:function(){this.logger.log.apply(this.logger,arguments)},current:function(){var e=this.sequence.current();return e||this.q.resolve(),e},next:function(){return this.sequence.next()},prev:function(){return this.sequence.prev()}}),f}return n.$inject=["$q","Database","Logger","QuestSequence","taskParse","dfltQuestLogger","$rootScope"],n});
define(["require","taskManager/API","underscore","text!pi/messageTemplate.jst","text!pi/messageTemplateDebrief.jst","text!pi/messageTemplatePanel.jst"],function(e){function u(){t.call(this),this.settings.onPreTask=a}function a(e,t,o){var u=o.global,a,c,h={taskName:e.name||"namelessTask",taskNumber:e.$meta.number};if(e.type=="quest"||e.type=="pip")a=e.$script.settings,a.logger=a.logger||{},a.logger.meta=angular.extend(a.logger.meta||{},h);return e.type=="message"&&e.piTemplate&&(c={content:e.$template,global:u,current:u.current,task:e},e.piTemplate=="debrief"?(n.extend(c,{showFeedback:n.bind(l,null,u),showPanel:f}),e.$template=n.template(s)(c),e.$template=n.template(e.$template)(c)):e.$template=n.template(i)(c)),e.last&&(h.sessionStatus="C"),r?!0:t.post("/implicit/PiManager",h)}function f(e,t,r){return n.template(o,{content:e,header:t,footer:r})}function l(e,t){n.isPlainObject(t)||(t={}),n.defaults(t,{pre:"<p>",post:"</p>",wrap:!0,header:"",noFeedback:"<p>No feedback was found</p>",property:"feedback",exclude:[]});var r=n(e).filter(function(e,r){if(!n.isArray(t.exclude))throw Error("Exclude must be an array");return n.isPlainObject(e)&&!n.isUndefined(e[t.property])&&n.indexOf(t.exclude,r)===-1}).mapValues(function(e){return t.pre+e[t.property]+t.post}).reduce(function(e,t){return e+t},"")||t.noFeedback;return t.wrap?f(r,t.header):r}var t=e("taskManager/API"),n=e("underscore"),r=/^(localhost|127.0.0.1)/.test(location.host),i=e("text!pi/messageTemplate.jst"),s=e("text!pi/messageTemplateDebrief.jst"),o=e("text!pi/messageTemplatePanel.jst");return n.extend(u.prototype,t.prototype),a.$inject=["currentTask","$http","$rootScope"],u});
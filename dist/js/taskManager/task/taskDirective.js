define(["require","underscore"],function(e){function n(e,n,r,i,s){return{scope:{task:"=piTask"},link:function(o,u){function m(e){var t=e.key||e.which||e.keyCode;t==82&&e.ctrlKey&&y(e,"current"),t==27&&r.one("keydown",g)}function g(e){var t=e.which||e.keyCode;t==37&&y(e,"prev"),t==39&&y(e,"next")}function y(e,t){e.preventDefault(),p={type:t,bustCache:!0},c.resolve()}var a=o.task,f,l,c,h,p,d=o.$parent.settings||{},v=a.$script||{};if(!a)return;d.skip&&(r.on("keydown",m),o.$on("$destroy",function(){r.off("keydown",m),r.off("keydown",g)})),s.current=i.piGlobal.current=v.current||{},v.name&&(t.extend(s.current,i.piGlobal[v.name]||{}),i.piGlobal[v.name]=v.current),c=e(a,u,o.$new()),h=c.promise,f=n(a.canvas),h["finally"](f),a.title&&(l=r[0].title,r[0].title=a.title,h["finally"](function(){r[0].title=l})),h["finally"](function(){o.$emit("task:done",p)})}}}var t=e("underscore");return n.$inject=["taskActivate","managerCanvas","$document","$window","$rootScope"],n});
define(["require","text!./piqPage.html","underscore"],function(e){function r(e,t,r){function s(){e.$emit("quest:refresh")}function o(n){i.log={name:n.name,startTime:+(new Date)},n.timeout&&(i.timeoutDeferred=t(function(){i.log.timeout=!0,e.submit(!0),n.timeoutMessage&&alert(n.timeoutMessage)},n.timeout,!1))}var i=this;e.global=r.global,e.current=r.current,this.harvest=function(t){var r=e.current.questions;n.each(e.page.questions,function(n){if(!n.name||!t&&!n.lognow)return;var s=r[n.name];if(s.$logged)return;e.$emit("quest:log",s,i.log),s.$logged=!0})},e.submit=function(t){var n=e.pageForm.$valid;e.submitAttempt=!0;if(!n&&t!==!0)return!0;e.$broadcast("quest:submit"),i.proceed(),e.$emit("quest:next")},e.decline=function(){e.$broadcast("quest:decline"),i.proceed(),e.$emit("quest:next")},e.prev=function(){i.proceed(),e.$broadcast("quest:prev")},this.proceed=function(){i.timeoutDeferred&&(t.cancel(i.timeoutDeferred),delete i.timeoutDeferred),i.harvest(e.page.lognow)},o(e.page),e.$watch("current.questions",s,!0),e.$on("quest:submit:now",function(){e.submit()})}function i(){return{replace:!0,controller:r,template:t}}var t=e("text!./piqPage.html"),n=e("underscore");return r.$inject=["$scope","$timeout","$rootScope"],i});
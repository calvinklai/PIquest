define(["require","underscore"],function(e){function n(e,n,r,i,s){return{scope:{task:"=piTask"},link:function(o,u){function g(e){var t=e.key||e.which||e.keyCode;t==82&&e.ctrlKey&&b(e,"current"),t==27&&r.one("keydown",y)}function y(e){var t=e.which||e.keyCode;t==37&&b(e,"prev"),t==39&&b(e,"next")}function b(e,t){e.preventDefault(),p={type:t,bustCache:!0},c.resolve()}var a=o.task,f,l,c,h,p,d=o.$parent.settings||{},v=a.$script||{},m=a.name||v.name;if(!a)return;d.skip&&(r.on("keydown",g),o.$on("$destroy",function(){r.off("keydown",g),r.off("keydown",y)})),s.current=i.piGlobal.current=v.current||{},m&&(t.extend(s.current,i.piGlobal[m]||{}),i.piGlobal[m]=v.current),c=e(a,u,o.$new()),h=c.promise,f=n(a.canvas),h["finally"](f),a.title&&(l=r[0].title,r[0].title=a.title,h["finally"](function(){r[0].title=l})),h["finally"](function(){o.$emit("task:done",p)})}}}var t=e("underscore");return n.$inject=["taskActivate","managerCanvas","$document","$window","$rootScope"],n});
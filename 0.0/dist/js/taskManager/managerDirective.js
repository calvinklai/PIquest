define(["require","underscore"],function(e){function n(e,n,r,i){function s(s){function f(r){function i(e){if(!t.isString(e))return;return e.substring(0,e.lastIndexOf("/"))}e.script=r,e.settings=r&&r.settings||{},o.manager=new n(e,r),o.manager.setBaseUrl(i(u)),e.$emit("manager:next")}function l(e){i("manager").error("Failed to load "+u,e)}var o=this,u;try{u=e.$eval(s)}catch(a){}finally{u||(u=s)}r(u).then(f,l)}this.init=s}function r(e,r,i){return{priority:1e3,replace:!0,template:'<div pi-swap><div pi-task="task" ng-class="{\'pi-spinner\':loading}"></div></div>',controller:n,require:["piManager","piSwap"],link:function(n,s,o,u){function h(){n.loading=!1,c=l,l=f.manager.current(),i("manager").debug("Manager:currentTask",l),l?p():d()}function p(){var e={prevTask:c,currentTask:l};m([n.settings.onPreTask,c&&c.post,l.pre,t.bind(a.next,a,{task:l,settings:n.settings}),function(){n.loading=!1}],e)}function d(){var e={prevTask:c,currentTask:l};m([c&&c.post,t.bind(a.empty,a),n.settings.onEnd,function(){n.loading=!1,n.$emit("manager:done")}],e)}function v(e,t){e.stopPropagation(),n.loading=!0,n.$emit("manager:next",t)}function m(n,s){var o=e.when();t(n).map(function(n){return function(){var i=t.isFunction(n)?r.invoke(n,null,s||{}):n;return e.when(i)}}).reduce(function(e,t){return e.then(t,function(e){i("manager").error("There was an error in the task sequence. ",e)})},o)}var a=u[1],f=u[0],l,c;f.init(o.piManager),n.$on("manager:loaded",h),n.$on("task:done",v),n.loading=!0}}}var t=e("underscore");return n.$inject=["$scope","managerService","managerLoad","piConsole"],r.$inject=["$q","$injector","piConsole"],r});
define(["require","text!./piqPage.html","underscore","angular"],function(e){function i(e,t,i){function o(){e.$emit("quest:refresh")}function u(n){s.log={name:n.name,startTime:+(new Date)},n.timeout&&(s.timeoutDeferred=t(function(){s.log.timeout=!0,e.submit(!0),n.timeoutMessage&&alert(n.timeoutMessage)},n.timeout,!1))}var s=this;e.global=i.global,e.current=i.current,this.harvest=function(t){var r=e.current.questions;n.each(e.page.questions,function(n){if(!n.name||!t&&!n.lognow)return;var i=r[n.name];if(i.$logged)return;e.$emit("quest:log",i,s.log),i.$logged=!0})},e.submit=function(t){var n=e.pageForm.$valid;e.submitAttempt=!0;if(!n&&t!==!0)return!0;e.$broadcast("quest:submit"),s.proceed(),e.$emit("quest:next")},e.decline=function(t){var n=r.element(t.target),i=this.page.decline!=="double";i||n.hasClass("active")?(e.$broadcast("quest:decline"),s.proceed(),e.$emit("quest:next")):n.addClass("active")},e.prev=function(){s.proceed(),e.$broadcast("quest:prev")},this.proceed=function(){s.timeoutDeferred&&(t.cancel(s.timeoutDeferred),delete s.timeoutDeferred),s.harvest(e.page.lognow)},u(e.page),e.$watch("current.questions",o,!0),e.$on("quest:submit:now",function(){e.submit()})}function s(){return{replace:!0,controller:i,template:t}}var t=e("text!./piqPage.html"),n=e("underscore"),r=e("angular");return i.$inject=["$scope","$timeout","$rootScope"],s});
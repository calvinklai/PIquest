define(["require","underscore"],function(e){function n(e){function n(e){this.sequence=e,this.stack=[],this.add(e),this.pointer=0}return t.extend(n.prototype,{add:function(e,t){this.stack.push({pointer:t?e.length:-1,sequence:e})},proceed:function(n,r){var i=this.stack[this.stack.length-1],s=n==="next";if(!i)throw new Error("mixerSequence: subSequence not found");i.pointer+=s?1:-1;var o=i.sequence[i.pointer];return t.isUndefined(o)&&this.stack.length>1?(this.stack.pop(),this.proceed.call(this,n,r)):o&&o.mixer?(this.add(e(o,r),!s),this.proceed.call(this,n,r)):this},next:function(e){return this.pointer++,this.proceed.call(this,"next",e)},prev:function(e){return this.pointer--,this.proceed.call(this,"prev",e)},current:function(){var e=this.stack[this.stack.length-1];if(!e)throw new Error("mixerSequence: subSequence not found");var t=e.sequence[e.pointer];return t?(t.$meta=this.meta(),t):undefined},meta:function(){return{number:this.pointer,outOf:t.reduce(this.stack,function(e,t){return e+t.sequence.length-1},0)+1}}}),n}var t=e("underscore");return n.$inject=["mixer"],n});